---
title: "Gjenstående funn"
output: html_notebook
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(lwgeom)
library(leaflet)
library(knitr)
library(flextable)
library(scales)

knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = TRUE)
```

```{r functions}
# To calculate distance from 
# 1. home location N 63° 23.567′ E 10° 25.026′
my_pois <- tibble::tibble(place_name = c("home"),
                          lon = c(10.41710),
                          lat = c(63.39278)) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326)

#pq_layers <- sf::st_layers(pocket_query)

# TODO: differentiate bewtween pq and downloaded list: The former has DT info, the latter doesn't!

read_pq_data <- function(pq_gpx_file) {
  
  pq_data <- sf::st_read(pq_gpx_file, layer = "waypoints", quiet = TRUE) %>%
    dplyr::select(gc_code = name, title = urlname, desc, placed_on = time, type) %>%
    dplyr::filter(stringr::str_detect(gc_code, "^GC")) %>%
    tidyr::separate(desc, c("name_dup", "rest"), sep = "by ") %>%
    tidyr::separate(rest, c("co", "dt"), sep = "\\(") %>%
    tidyr::separate(dt, c("difficulty", "terrain"), sep = "/") %>%
    dplyr::mutate(co = stringr::str_replace(co, ", Traditional Cache", ""),
                  co = stringr::str_replace(co, ", Virtual Cache", ""),
                  co = stringr::str_replace(co, ", Earthcache", ""),
                  difficulty = as.numeric(difficulty),
                  terrain = as.numeric(stringr::str_sub(terrain, 1, -2)),
                  placed_on = lubridate::as_date(placed_on),
                  year = lubridate::year(placed_on),
                  month = lubridate::month(placed_on),
                  day = lubridate::mday(placed_on),
                  type = stringr::str_sub(type, 10, -1),
                  distance_from_home = sf::st_distance(geometry, my_pois$geometry[1]) %>%
                    round()) %>%
    dplyr::select(type, gc_code, title, co, difficulty, terrain, 
                  placed_on, year, month, day,
                  distance_from_home)
  }
```


```{r read}

#pq_data <- read_pq_data("gclists/to_find_trd.gpx")
  
trondheim_kommune <- read_pq_data("gclists/trd_kommune.gpx") %>% 
  dplyr::mutate(Kommune = "Trondheim")

rendalen_kommune <- read_pq_data("gclists/rendalen_kommune.gpx") %>% 
  dplyr::mutate(Kommune = "Rendalen")

missing_finds_per_year <- 
  dplyr::bind_rows(
    trondheim_kommune,
    rendalen_kommune
  ) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(year, Kommune) %>% 
  dplyr::summarise(antall = n(), .groups = "drop") %>% 
  tidyr::complete(year = 2001:2021, nesting(Kommune), fill = list(antall = 0)) %>% 
  tidyr::pivot_wider(names_from = Kommune, values_from = antall)
  
missing_finds_total <- 
  dplyr::bind_rows(
    trondheim_kommune,
    rendalen_kommune
  ) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(Kommune) %>% 
  dplyr::summarise(antall = n(), .groups = "drop") %>% 
  tidyr::pivot_wider(names_from = Kommune, values_from = antall)
```

Antall manglende cachefunn per utleggsår.

```{r trd_table_per_year}
missing_finds_per_year %>% 
  flextable::flextable() %>% 
  colformat_double(j = 1, big.mark = "", digits = 0) %>% 
  set_header_labels(year = "Utleggsår") %>% 
  theme_booktabs(bold_header = TRUE) %>% 
  bg(bg = "#c0c0c0", part = "header") %>% 
  bg(i = ~ Rendalen == 0, j = 2, bg = "#099900", part = "body") %>% 
  bg(i = ~ Trondheim == 0, j = 3, bg = "#099900", part = "body")
```


```{r trd_table_total}
missing_finds_total %>% 
  flextable::flextable() %>% 
  theme_booktabs(bold_header = TRUE) %>% 
  bg(bg = "#c0c0c0", part = "header")
```

